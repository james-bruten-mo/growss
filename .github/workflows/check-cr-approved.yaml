# ------------------------------------------------------------------------------
# (c) Crown copyright Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.
# ------------------------------------------------------------------------------

name: Check CR Approval

on:
  workflow_call:

permissions: read-all

jobs:
  cr_check:
    runs-on: ubuntu-24.04
    timeout-minutes: 2

    steps:
      - name: Check for Code Reviewer approval
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Running on PR #$PR_NUMBER in Repository $REPO"

          # -- 1. Extract the assigned Code Reviewer from the PR body
          CODE_REVIEWER=$(echo "$PR_BODY" | grep -oP "Code Reviewer:\s?@\K([a-z\d](?:[a-z\d]|-(?=[a-z\d])){0,38})") || true

          if [[ -z "$CODE_REVIEWER" ]]; then
            echo "::error::No 'Code Reviewer: @<username>' found in the PR body."
            echo "::notice::This action may be bypassed by a reviewer with sufficient permissions if appropriate."
            exit 1
          fi
          echo "Expected Code Reviewer: $CODE_REVIEWER"

          # -- 2. Check the review status
          reviews=$(gh pr view -R "$REPO" "$PR_NUMBER" --json "reviews" | jq -r --arg cr "$CODE_REVIEWER" '
                    [ .reviews[] | select(.author.login == $cr) ]')

          # Check if any review is APPROVED
          approved=$(echo "$reviews" | jq -r '[ .[] | select(.state == "APPROVED") ] | length')

          if [[ "$approved" -gt 0 ]]; then
            echo "âœ… Success: The listed Code Reviewer ($CODE_REVIEWER) has approved this PR."
          else
            echo "::error::The listed Code Reviewer ($CODE_REVIEWER) has not yet approved this PR."
            echo "Current reviews for this user:"
            echo "$reviews" | jq -r '.[] | "- \(.state)"'
            echo "::notice::This action may be bypassed by a reviewer with sufficient permissions if appropriate."
            exit 1
          fi
